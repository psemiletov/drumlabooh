cmake_minimum_required(VERSION 3.15)
include(FetchContent)

project(DRUMLABOOH LANGUAGES CXX C VERSION 12.1.0)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# ========== ОПЦИИ КОНФИГУРАЦИИ ==========
option(MULTI "Build with multi-channel support" ON)
option(INSTALLKITS "Bundle and install kits" ON)
option(LOCALINSTALL "Install to the $HOME subdirs" OFF)

message(STATUS "Building for: ${CMAKE_SYSTEM_NAME}")

add_definitions(-DVERSION_NUMBER="${PROJECT_VERSION_MAJOR}.${PROJECT_VERSION_MINOR}.${PROJECT_VERSION_PATCH}")

# ========== ПЛАТФОРМЕННО-СПЕЦИФИЧНЫЕ НАСТРОЙКИ ==========
if(APPLE)
    message(STATUS "=== CONFIGURING FOR macOS (AU ONLY) ===")
    set(CMAKE_OSX_DEPLOYMENT_TARGET "10.15")
    set(CMAKE_OSX_ARCHITECTURES "x86_64;arm64")

    set(DRUMSKLADTAG "4.0.0")
    set(JUCETAG "8.0.11")
    set(PLUGIN_FORMATS AU)

elseif(WIN32)
    message(STATUS "=== CONFIGURING FOR WINDOWS ===")
    set(DRUMSKLADTAG "4.0.0")
    set(JUCETAG "7.0.10")
    set(PLUGIN_FORMATS VST3)

    if(MSVC)
        set(CMAKE_MSVC_RUNTIME_LIBRARY "MultiThreaded$<$<CONFIG:Debug>:Debug>")
    endif()

else()  # Linux
    message(STATUS "=== CONFIGURING FOR LINUX ===")
    set(DRUMSKLADTAG "4.0.0")
    set(JUCETAG "8.0.11")
    set(PLUGIN_FORMATS VST3 LV2)

endif()

# ========== ЗАВИСИМОСТИ ==========
set(FETCHCONTENT_QUIET FALSE)
cmake_policy(SET CMP0135 NEW)

FetchContent_Declare(
    juce
    URL https://github.com/juce-framework/JUCE/archive/refs/tags/${JUCETAG}.tar.gz
    EXCLUDE_FROM_ALL
)

if(INSTALLKITS)
    FetchContent_Declare(
        drum_sklad
        URL https://github.com/psemiletov/drum_sklad/archive/refs/tags/${DRUMSKLADTAG}.zip
        DOWNLOAD_EXTRACT_TIMESTAMP TRUE
        EXCLUDE_FROM_ALL
    )
endif()

FetchContent_MakeAvailable(juce)
if(INSTALLKITS)
    FetchContent_MakeAvailable(drum_sklad)
endif()

# ========== ФУНКЦИЯ ДЛЯ СОЗДАНИЯ ПЛАГИНА ==========
function(create_drumlabooh_plugin target_name is_multi)
    message(STATUS "Creating plugin: ${target_name} (multi: ${is_multi})")

    if(UNIX AND NOT APPLE)
        set(lv2_uri "https://github.com/psemiletov/${target_name}")
    else()
        set(lv2_uri "")
    endif()

    juce_add_plugin(${target_name}
        COMPANY_NAME "Semiletov"
        IS_SYNTH TRUE
        NEEDS_MIDI_INPUT TRUE
        EDITOR_WANTS_KEYBOARD_FOCUS TRUE
        VST3_CATEGORIES "Instrument|Sampler|Synth|Drum|Generator"
        PLUGIN_MANUFACTURER_CODE "PetR"
        PLUGIN_CODE "Petr"
        FORMATS ${PLUGIN_FORMATS}
        PRODUCT_NAME "${target_name}"
        NEEDS_WEB_BROWSER FALSE
        JUCE_DISPLAY_SPLASH_SCREEN FALSE
        AU_MAIN_TYPE kAudioUnitType_MusicDevice   # ← КЛЮЧЕВОЙ ФИКС ДЛЯ AU ИНСТРУМЕНТА!
    )

    if(UNIX AND NOT APPLE)
        set_target_properties(${target_name} PROPERTIES
            LV2URI ${lv2_uri}
            LV2_SHARED_LIBRARY_NAME ${target_name}
        )
    endif()

    juce_generate_juce_header(${target_name})

    target_sources(${target_name}
        PRIVATE
            ./Source/PluginEditor.cpp
            ./Source/PluginProcessor.cpp
            ./Source/pugixml.cpp
            ./Source/dsp.cpp
            ./Source/kits.cpp
            ./Source/utl.cpp
            ./Source/fx-resofilter.cpp
            ./Source/resampler.c
    )

    target_compile_definitions(${target_name}
        PUBLIC
            JUCE_JACK=0
            NEEDS_WEBVIEW2=0
            JUCE_PLUGINHOST_LADSPA=0
            JUCE_WEB_BROWSER=0
            JUCE_USE_CURL=0
            JUCE_VST3_CAN_REPLACE_VST2=0
            VERSION_NUMBER="${PROJECT_VERSION_MAJOR}.${PROJECT_VERSION_MINOR}.${PROJECT_VERSION_PATCH}"
    )

    if(${is_multi})
        target_compile_definitions(${target_name} PUBLIC MULTICHANNEL=1)
    endif()

    if(APPLE)
        target_compile_definitions(${target_name}
            PUBLIC
                JUCE_PUSH_NOTIFICATIONS=0
                JUCE_MODAL_LOOPS_PERMITTED=1
                JUCE_STRICT_REFCOUNTEDPOINTER=1
        )
    endif()

    # Стандартная линковка для плагина-инструмента с GUI
    target_link_libraries(${target_name}
        PRIVATE
            juce::juce_audio_basics
            juce::juce_audio_devices
            juce::juce_audio_formats
            juce::juce_audio_processors
            juce::juce_audio_utils
            juce::juce_audio_plugin_client   # Для AU wrapper
            juce::juce_core
            juce::juce_data_structures
            juce::juce_events
            juce::juce_graphics
            juce::juce_gui_basics
            juce::juce_gui_extra
        PUBLIC
            juce::juce_recommended_config_flags
            juce::juce_recommended_lto_flags
            juce::juce_recommended_warning_flags
    )

endfunction()

# ========== СОЗДАНИЕ ПЛАГИНОВ ==========
create_drumlabooh_plugin(drumlabooh FALSE)
if(MULTI)
    create_drumlabooh_plugin(drumlabooh-multi TRUE)
endif()

# ========== УСТАНОВКА ==========
if(INSTALLKITS)
    install(DIRECTORY ${drum_sklad_SOURCE_DIR}/ DESTINATION ${KITS_INSTALL_DIR} PATTERN ".git" EXCLUDE)
endif()

message(STATUS "==========================================")
message(STATUS "Configuration Summary")
message(STATUS "Platform: ${CMAKE_SYSTEM_NAME}")
message(STATUS "Plugin formats: ${PLUGIN_FORMATS}")
message(STATUS "Multi-channel: ${MULTI}")
if(APPLE)
    message(STATUS "macOS deployment target: ${CMAKE_OSX_DEPLOYMENT_TARGET}")
    message(STATUS "Architectures: ${CMAKE_OSX_ARCHITECTURES}")
endif()
message(STATUS "==========================================")