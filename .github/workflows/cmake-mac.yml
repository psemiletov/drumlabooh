# macOS AU build for plugins (CMake)
name: CMake macOS AU CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  BUILD_TYPE: Release

jobs:
  build-macos-au:
    name: Build AU on macOS (matrix)
    runs-on: macos-latest

    strategy:
      matrix:
        arch: [universal]
        plugin: [drumlabooh, drumlabooh-multi]

    # Вычисляем архитектуры (универсальная -> "x86_64;arm64")
    env:
      CMAKE_ARCHS: ${{ matrix.arch == 'universal' && 'x86_64;arm64' || matrix.arch }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup macOS
        run: |
          echo "=== System Information ==="
          echo "Architecture: $(uname -m)"
          echo "macOS: $(sw_vers -productVersion)"
          echo "Available CMake files:"
          ls -la CMakeLists*.txt || true
          sysctl -n hw.ncpu

      - name: Install minimal dependencies
        run: |
          brew update
          brew install cmake

      - name: Prepare CMakeLists for macOS build
        run: |
          # Если есть специальный CMakeLists-alloses.txt — используем его как основной CMakeLists.txt
          if [ -f "CMakeLists-alloses.txt" ]; then
            echo "✓ CMakeLists-alloses.txt found — using it as CMakeLists.txt"
            cp CMakeLists-alloses.txt CMakeLists.txt
          else
            echo "✗ CMakeLists-alloses.txt not found — using repository CMakeLists.txt"
          fi
          echo "Resulting CMakeLists:"
          head -n 20 CMakeLists.txt || true

      - name: Configure CMake for AU only
        run: |
          echo "Configuring for AU format only using CMakeLists.txt"
          cmake -S . -B "build-au-${{ matrix.arch }}" \
            -DCMAKE_BUILD_TYPE="${{ env.BUILD_TYPE }}" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.13 \
            -DCMAKE_OSX_ARCHITECTURES="${{ env.CMAKE_ARCHS }}" \
            -DINSTALLKITS=OFF \
            -DLOCALINSTALL=OFF \
            -DMULTI=ON

          echo "=== CMake Configuration Summary ==="
          cmake -S . -B "build-au-${{ matrix.arch }}" -L | grep -E "(JUCE|FORMATS|PLUGIN|APPLE|AU|VST3)" || true

      - name: Build AU components
        run: |
          echo "Building AU components for ${{ matrix.plugin }}"
          cmake --build "build-au-${{ matrix.arch }}" \
            --config "${{ env.BUILD_TYPE }}" \
            --target "${{ matrix.plugin }}" \
            --parallel "$(sysctl -n hw.ncpu)"

          echo "=== Built AU Components ==="
          find "build-au-${{ matrix.arch }}" -name "*.component" -type d -print || true

      - name: Verify AU bundles
        run: |
          echo "=== Verifying AU Bundle Structure ==="
          for component in build-au-"${{ matrix.arch }}"/*"${{ matrix.plugin }}"*"_artefacts"/AU/*.component 2>/dev/null; do
            if [ -d "$component" ]; then
              echo "Component: $(basename "$component")"
              if [ -f "$component/Contents/Info.plist" ]; then
                echo "  ✓ Info.plist exists"
              else
                echo "  ✗ Info.plist missing"
              fi
              binary="$component/Contents/MacOS/$(basename "${component%.component}")"
              if [ -f "$binary" ]; then
                echo "  ✓ Binary exists ($(lipo -info "$binary" 2>/dev/null || echo "Unknown arch"))"
              else
                echo "  ✗ Binary missing: $binary"
              fi
              echo ""
            fi
          done

      - name: Self-sign AU components
        run: |
          echo "=== Self-signing AU Components ==="
          for component in build-au-"${{ matrix.arch }}"/*"${{ matrix.plugin }}"*"_artefacts"/AU/*.component 2>/dev/null; do
            if [ -d "$component" ]; then
              echo "Signing: $(basename "$component")"
              codesign --force --sign - --timestamp --options runtime "$component" || echo "codesign failed for $component"
            fi
          done

      - name: Create AU package
        run: |
          echo "=== Creating AU Package ==="
          PKG_DIR="pkg-au-${{ matrix.plugin }}-${{ matrix.arch }}"
          rm -rf "$PKG_DIR"
          mkdir -p "$PKG_DIR"

          for component in build-au-"${{ matrix.arch }}"/*"${{ matrix.plugin }}"*"_artefacts"/AU/*.component 2>/dev/null; do
            if [ -d "$component" ]; then
              echo "Packaging: $(basename "$component")"
              cp -R "$component" "$PKG_DIR/"
            fi
          done

          cat > "$PKG_DIR/README.txt" << EOF
========================================
${{ matrix.plugin }} - AU Audio Unit
Build Date: $(date)

Installation:
1. Copy the .component file to:
   /Library/Audio/Plug-Ins/Components/
2. Rescan plugins in your DAW
========================================
EOF

          tar czf "${{ matrix.plugin }}-macOS-AU-${{ matrix.arch }}.tar.gz" -C "$PKG_DIR" .
          echo "Package created: ${{ matrix.plugin }}-macOS-AU-${{ matrix.arch }}.tar.gz"
          ls -lh "${{ matrix.plugin }}-macOS-AU-${{ matrix.arch }}.tar.gz" || true

      - name: Upload AU artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.plugin }}-macOS-AU-${{ matrix.arch }}
          path: ${{ matrix.plugin }}-macOS-AU-${{ matrix.arch }}.tar.gz
          retention-days: 7