name: Build macOS AU Plugins

on:
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build-macos-au:
    name: Build Universal AU (macOS)
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install Build Dependencies
        run: |
          echo "=== Installing dependencies ==="
          
          # –û–±–Ω–æ–≤–ª—è–µ–º Homebrew
          brew update
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º CMake (–ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é)
          brew install cmake
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏
          echo "=== Installed versions ==="
          cmake --version
          xcodebuild -version
          sw_vers -productVersion
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º pkg-config –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          brew install pkg-config || true

      - name: Configure CMake with Debug Info
        run: |
          echo "=== Starting CMake Configuration ==="
          echo "Build type: ${{ env.BUILD_TYPE }}"
          echo "Current directory: $(pwd)"
          
          if [ ! -f "CMakeLists.txt" ]; then
            echo "ERROR: CMakeLists.txt not found!"
            ls -la
            exit 1
          fi
          
          echo "=== CMakeLists.txt content (first 10 lines) ==="
          head -10 CMakeLists.txt
          
          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º CMake
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15 \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DMULTI=ON \
            -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON \
            -DCMAKE_EXPORT_COMPILE_COMMANDS:BOOL=ON \
            2>&1 | tee cmake_configure.log
          
          echo "=== CMake configuration complete ==="

      - name: Build AU Plugins
        run: |
          echo "=== Starting Build Process ==="
          echo "CPU cores: $(sysctl -n hw.ncpu)"
          
          # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
          cmake --build build \
            --config ${{ env.BUILD_TYPE }} \
            --parallel $(sysctl -n hw.ncpu) \
            2>&1 | tee cmake_build.log
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞
          BUILD_EXIT_CODE=$?
          echo "=== Build exit code: $BUILD_EXIT_CODE ==="
          
          # –î–∞–∂–µ –µ—Å–ª–∏ –æ—à–∏–±–∫–∞, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "‚ö†Ô∏è Build had errors, but continuing for diagnostics..."
          fi

      - name: Diagnostic - Check Build Output
        run: |
          echo "=== Build Diagnostics ==="
          
          echo "1. Listing build directory:"
          ls -la build/ 2>/dev/null || echo "  build/ not found"
          
          echo ""
          echo "2. Looking for JUCE directories:"
          find build -type d -name "*juce*" -o -name "*JUCE*" 2>/dev/null | head -10 || true
          
          echo ""
          echo "3. Checking for built libraries/executables:"
          find build -type f \( -name "*.dylib" -o -name "*.so" -o -perm +111 \) 2>/dev/null | head -10 || true
          
          echo ""
          echo "4. CMake targets:"
          if [ -d "build" ]; then
            cmake --build build --target help 2>&1 | grep -E "(drumlabooh|ALL_BUILD|help)" || true
          fi

      - name: Find AU Bundles
        run: |
          echo "=== Searching for AU Bundles ==="
          
          # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å–æ –≤—Å–µ–º–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
          find build -type d -name "*.component" > components_found.txt 2>/dev/null || true
          
          if [ -s components_found.txt ]; then
            echo "‚úÖ FOUND AU COMPONENTS:"
            cat components_found.txt
            echo ""
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
            while IFS= read -r component; do
              echo "üîç Examining: $component"
              if [ -d "$component/Contents" ]; then
                echo "  ‚úì Has Contents directory"
                if [ -f "$component/Contents/Info.plist" ]; then
                  echo "  ‚úì Has Info.plist"
                  # –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å CFBundleIdentifier
                  BUNDLE_ID=$(defaults read "$component/Contents/Info" CFBundleIdentifier 2>/dev/null || true)
                  if [ -n "$BUNDLE_ID" ]; then
                    echo "  ‚úì Bundle ID: $BUNDLE_ID"
                  fi
                fi
                if [ -d "$component/Contents/MacOS" ]; then
                  echo "  ‚úì Has MacOS directory"
                  for binary in "$component/Contents/MacOS/"*; do
                    if [ -f "$binary" ]; then
                      echo "  ‚úì Binary: $(basename "$binary")"
                      # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
                      if command -v lipo &> /dev/null; then
                        lipo -info "$binary" 2>/dev/null || echo "    Could not check architectures"
                      fi
                    fi
                  done
                fi
              fi
              echo ""
            done < components_found.txt
          else
            echo "‚ùå NO .component files found!"
            echo ""
            echo "Deep search in build directory:"
            find build -type d 2>/dev/null | grep -i "arte\|output\|plugin" || echo "  No relevant directories found"
          fi

      - name: Create Package
        run: |
          echo "=== Creating Package ==="
          mkdir -p package/plugins
          
          # –ö–æ–ø–∏—Ä—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
          if [ -f components_found.txt ] && [ -s components_found.txt ]; then
            echo "Copying found components..."
            while IFS= read -r component; do
              if [ -d "$component" ]; then
                COMP_NAME=$(basename "$component")
                echo "  Adding: $COMP_NAME"
                cp -R "$component" "package/plugins/"
              fi
            done < components_found.txt
            
            COUNT=$(ls -1 package/plugins/*.component 2>/dev/null | wc -l | tr -d ' ')
            echo "‚úÖ Packaged $COUNT plugin(s)"
          else
            echo "‚ö†Ô∏è No components to package"
            echo "This could mean:" > package/README.txt
            echo "1. Build failed" >> package/README.txt
            echo "2. Plugin format not set correctly" >> package/README.txt
            echo "3. JUCE output path different than expected" >> package/README.txt
          fi
          
          # –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ–º README
          cat > package/README.md << 'EOF'
          # Drumlabooh AU Plugins
          
          ## Installation
          Copy the .component files to:
          - ~/Library/Audio/Plug-Ins/Components/ (for current user)
          - /Library/Audio/Plug-Ins/Components/ (for all users)
          
          ## Build Info
          - Build date: $(date)
          - Build type: ${{ env.BUILD_TYPE }}
          - macOS target: 10.15+
          - Architectures: Universal (x86_64 + arm64)
          EOF
          
          # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤
          cd package
          tar czf ../drumlabooh-macos-au.tar.gz .
          cd ..
          
          echo "üì¶ Package created: drumlabooh-macos-au.tar.gz"
          ls -lh drumlabooh-macos-au.tar.gz

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-debug-logs
          path: |
            cmake_configure.log
            cmake_build.log
            components_found.txt
          retention-days: 7

      - name: Upload AU Plugins Package
        uses: actions/upload-artifact@v4
        with:
          name: drumlabooh-au-plugins
          path: drumlabooh-macos-au.tar.gz
          retention-days: 30
          
      - name: Final Status Report
        if: always()
        run: |
          echo "=== BUILD STATUS REPORT ==="
          if [ -f components_found.txt ] && [ -s components_found.txt ]; then
            COMP_COUNT=$(wc -l < components_found.txt)
            echo "‚úÖ SUCCESS: Found $COMP_COUNT AU plugin component(s)"
            echo "Components:"
            cat components_found.txt
          else
            echo "‚ùå FAILURE: No AU plugins were built"
            echo ""
            echo "Next steps for debugging:"
            echo "1. Check cmake_configure.log for configuration errors"
            echo "2. Check cmake_build.log for compilation errors"
            echo "3. Verify CMakeLists.txt sets FORMATS to AU for macOS"
            echo "4. Check if JUCE is being fetched correctly"
          fi