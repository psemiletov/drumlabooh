name: Build macOS AU Plugins

on:
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build-macos-au:
    name: Build Universal AU (macOS)
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install CMake
        run: brew install cmake

      - name: Prepare CMakeLists.txt
        run: |
          if [ -f "CMakeLists-alloses.txt" ]; then
            cp CMakeLists-alloses.txt CMakeLists.txt
            echo "Using CMakeLists-alloses.txt"
          fi
          head -n 30 CMakeLists.txt

      - name: Configure CMake
        run: |
          cmake -S . -B build-au \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.13 \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DINSTALLKITS=OFF \
            -DMULTI=ON

      - name: Build AU Plugins (with full log)
        run: |
          echo "=== STARTING BUILD ==="
          cmake --build build-au \
            --config ${{ env.BUILD_TYPE }} \
            --parallel $(sysctl -n hw.ncpu) \
            --verbose || echo "Build completed (possibly with errors)"

          echo "=== BUILD FINISHED ==="
          echo "=== Contents of build-au directory ==="
          find build-au -type d -name "*Artefacts*" || echo "No _Artefacts folders"
          find build-au -name "*.component" || echo "No .component found anywhere"
          echo "=== Full tree of build-au (top levels) ==="
          ls -la build-au/
          ls -la build-au/*_Artefacts*/ 2>/dev/null || true
          ls -la build-au/*_Artefacts*/AU/ 2>/dev/null || true

      - name: Verify AU Bundle Structure
        run: |
          echo "=== Verifying AU Bundle Structure ==="
          shopt -s nullglob
          components=(build-au/*_Artefacts/AU/*.component build-au/*_Artefacts/Release/AU/*.component)

          if [ ${#components[@]} -eq 0 ]; then
            echo "✗ ERROR: No .component bundles found!"
            echo "Possible reasons:"
            echo "1. Build failed (check logs above)"
            echo "2. JUCE version mismatch in path"
            echo "3. Plugin formats not set to AU"
            find build-au -type f | head -20
            exit 1
          fi

          for component in "${components[@]}"; do
            name=$(basename "$component")
            echo "✓ Found component: $name"
            lipo -info "$component/Contents/MacOS/"* | head -5
          done

      # Остальные шаги (sign, package, upload) оставляем как раньше
      - name: Ad-hoc sign AU components
        run: |
          for c in build-au/*_Artefacts/{,Release/}AU/*.component; do
            [ -d "$c" ] && codesign --force --sign - --timestamp=none --options runtime "$c"
          done

      - name: Create Final Package
        run: |
          mkdir -p release-au-universal
          cp -R build-au/*_Artefacts/{,Release/}AU/*.component release-au-universal/ || true

          printf "%s\n" "Drumlabooh macOS AU Plugins — Universal" > release-au-universal/README.txt
          printf "Built: %s\n" "$(date)" >> release-au-universal/README.txt
          printf "Includes:\n" >> release-au-universal/README.txt
          ls release-au-universal/*.component | xargs basename | sed 's/^/  • /' >> release-au-universal/README.txt || true

          tar czf drumlabooh-macos-AU-universal.tar.gz -C release-au-universal .
          ls -lh drumlabooh-macos-AU-universal.tar.gz

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: drumlabooh-macos-AU-universal
          path: drumlabooh-macos-AU-universal.tar.gz
          retention-days: 30