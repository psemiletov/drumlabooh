# macOS AU build for plugins (CMake) — manual trigger only
name: CMake macOS AU CI

on:
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build-macos-au:
    name: Build AU on macOS (universal)
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: System Information
        run: |
          echo "=== System Information ==="
          uname -a
          sw_vers
          echo "CPU cores: $(sysctl -n hw.ncpu)"
          echo "Xcode version:"
          xcodebuild -version || true

      - name: Install dependencies
        run: |
          brew update
          brew install cmake

      - name: Prepare CMakeLists.txt
        run: |
          if [ -f "CMakeLists-alloses.txt" ]; then
            echo "Using CMakeLists-alloses.txt as CMakeLists.txt"
            cp CMakeLists-alloses.txt CMakeLists.txt
          else
            echo "Using default CMakeLists.txt from repository"
          fi
          head -n 20 CMakeLists.txt

      - name: Configure CMake (Universal AU)
        run: |
          cmake -S . -B build-au \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.13 \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DINSTALLKITS=OFF \
            -DMULTI=ON

          echo "=== Relevant CMake Cache Variables ==="
          cmake -B build-au -L | grep -E "(FORMATS|AU|APPLE|ARCHITECTURES|MULTI)" || true

      - name: Build both AU plugins
        run: |
          cmake --build build-au \
            --config ${{ env.BUILD_TYPE }} \
            --parallel $(sysctl -n hw.ncpu)

          echo "=== Built AU Components ==="
          find build-au -type d -name "*.component" | sort

      - name: Verify AU Bundle Structure
        run: |
          echo "=== Verifying AU Bundle Structure ==="
          shopt -s nullglob
          components=(build-au/*_Artefacts/AU/*.component)
          
          if [ ${#components[@]} -eq 0 ]; then
            echo "✗ No .component bundles found!"
            exit 1
          fi
          
          for component in "${components[@]}"; do
            name=$(basename "$component")
            echo "Component: $name"
            
            if [ -f "$component/Contents/Info.plist" ]; then
              echo "  ✓ Info.plist present"
              plutil -lint "$component/Contents/Info.plist" | head -5 || echo "  (plist warnings above)"
            else
              echo "  ✗ Info.plist missing!"
            fi
            
            binary="$component/Contents/MacOS/${name%.component}"
            if [ -f "$binary" ]; then
              echo "  ✓ Binary exists"
              lipo -info "$binary"
            else
              echo "  ✗ Binary missing: $binary"
            fi
            echo ""
          done

      - name: Run auval validation (non-fatal)
        run: |
          echo "=== Running auval validation ==="
          shopt -s nullglob
          for component in build-au/*_Artefacts/AU/*.component; do
            name=$(basename "$component" .component)
            echo "Validating: $name"
            # Для инструмента (IS_SYNTH=TRUE) тип — aumu, не aufx!
            auval -v aumu Petr PetR -t "$name" || echo "auval failed (code $?) — common during CI, check locally if needed"
            echo ""
          done
        continue-on-error: true  # Не падает весь job, если auval ругается

      - name: Self-sign AU components
        run: |
          echo "=== Self-signing with ad-hoc signature ==="
          for component in build-au/*_Artefacts/AU/*.component; do
            echo "Signing: $(basename "$component")"
            codesign --force --sign - --timestamp=none --options runtime "$component" \
              || echo "Warning: codesign failed (may be harmless in CI)"
          done

      - name: Create AU package
        run: |
          echo "=== Packaging AU plugins ==="
          mkdir -p release-au-universal
          
          cp -R build-au/*_Artefacts/AU/*.component release-au-universal/ || true
          
          # README
          cat > release-au-universal/README.txt << 'EOF'
========================================
Drumlabooh - macOS Audio Unit Plugins
========================================

Built: $(date)
Architecture: Universal (Intel + Apple Silicon)
Deployment target: macOS 10.13+

Plugins included:
$(ls *.component 2>/dev/null || echo "None found")

Installation:
1. Copy .component files to:
   /Library/Audio/Plug-Ins/Components/
   (or ~/Library/Audio/Plug-Ins/Components/ for current user)

2. Restart your DAW or rescan plugins.

Note: Plugins are ad-hoc signed (valid for local use).
EOF

          tar czf drumlabooh-macos-AU-universal.tar.gz -C release-au-universal .
          echo "Package created:"
          ls -lh drumlabooh-macos-AU-universal.tar.gz

      - name: Upload AU artifact
        uses: actions/upload-artifact@v4
        with:
          name: drumlabooh-macos-AU-universal
          path: drumlabooh-macos-AU-universal.tar.gz
          retention-days: 14