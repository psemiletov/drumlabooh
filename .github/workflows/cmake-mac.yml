name: Build macOS AU Plugins

on:
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build-macos-au:
    name: Build Universal AU (macOS)
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        run: |
          brew update
          brew install cmake
          brew install pkg-config
          cmake --version

      - name: Analyze CMakeLists-alloses.txt
        run: |
          echo "=== FULL ANALYSIS OF CMakeLists-alloses.txt ==="
          echo ""
          
          if [ ! -f "CMakeLists-alloses.txt" ]; then
            echo "❌ ERROR: CMakeLists-alloses.txt does not exist!"
            exit 1
          fi
          
          # Показываем полный файл
          echo "=== COMPLETE CMakeLists-alloses.txt ==="
          cat CMakeLists-alloses.txt
          echo ""
          
          echo "=== CRITICAL CHECKS ==="
          echo ""
          
          # 1. Проверяем project()
          echo "1. Project definition:"
          grep -n "project(" CMakeLists-alloses.txt || echo "  ❌ NOT FOUND!"
          
          # 2. Проверяем FORMATS
          echo ""
          echo "2. Plugin formats (CRITICAL FOR AU):"
          grep -n -i "FORMATS\|juce_add_plugin" CMakeLists-alloses.txt || echo "  ❌ NOT FOUND!"
          
          # 3. Проверяем APPLE-specific настройки
          echo ""
          echo "3. macOS/Apple specific settings:"
          grep -n -i "apple\|macos\|osx\|au_main_type" CMakeLists-alloses.txt || echo "  ⚠️ Not found"
          
          # 4. Проверяем JUCE
          echo ""
          echo "4. JUCE configuration:"
          grep -n -i "juce\|fetchcontent" CMakeLists-alloses.txt || echo "  ❌ NOT FOUND!"
          
          # 5. Проверяем создание плагинов
          echo ""
          echo "5. Plugin creation:"
          grep -n -B5 -A5 "create_drumlabooh\|add_plugin" CMakeLists-alloses.txt || echo "  ❌ NOT FOUND!"
          
          # 6. Копируем файл для использования
          echo ""
          echo "6. Copying CMakeLists-alloses.txt as main CMakeLists.txt"
          cp CMakeLists-alloses.txt CMakeLists.txt
          ls -la CMakeLists*.txt

      - name: Configure CMake with MAXIMUM Debug
        run: |
          echo "=== CMAKE CONFIGURATION (MAX DEBUG) ==="
          
          # Сначала пробуем с минимальными флагами
          echo "1. Basic configuration test:"
          cmake -S . -B build-test \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15 \
            2>&1 | head -100
          
          echo ""
          echo "2. Full configuration:"
          # Теперь полная конфигурация
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15 \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DMULTI=ON \
            --trace-expand 2>&1 | grep -A5 -B5 "juce\|plugin\|FORMATS\|error\|warning" | head -200 > cmake_trace_filtered.log
          
          echo "=== Filtered trace output (key parts) ==="
          cat cmake_trace_filtered.log
          
          echo ""
          echo "3. Standard configuration:"
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15 \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DMULTI=ON \
            2>&1 | tee cmake_configure_full.log | tail -100

      - name: Check CMake Configuration Results
        run: |
          echo "=== CONFIGURATION RESULTS ==="
          
          if [ ! -d "build" ]; then
            echo "❌ ERROR: build directory was not created!"
            exit 1
          fi
          
          echo "1. CMakeCache.txt analysis:"
          echo "   File exists: $( [ -f build/CMakeCache.txt ] && echo 'Yes' || echo 'No' )"
          
          echo ""
          echo "2. Key variables from CMakeCache:"
          grep -i "juce\|plugin\|au\|format\|apple" build/CMakeCache.txt 2>/dev/null | head -30 || echo "   None found"
          
          echo ""
          echo "3. Generated files:"
          find build -name "*.cmake" -type f 2>/dev/null | head -10 || echo "   None found"
          
          echo ""
          echo "4. Checking for JUCE:"
          find build -type d -name "*juce*" 2>/dev/null || echo "   JUCE not found in build directory"

      - name: Build and Capture Everything
        run: |
          echo "=== BUILD PROCESS ==="
          
          echo "1. Available targets:"
          cmake --build build --target help 2>&1 | tee targets.log
          
          echo ""
          echo "2. Building ALL targets:"
          # Пытаемся собрать всё
          cmake --build build \
            --config ${{ env.BUILD_TYPE }} \
            --parallel 2 \
            2>&1 | tee cmake_build_full.log | tail -100
          
          echo ""
          echo "3. Build exit code: $?"
          
          echo ""
          echo "4. What was actually created:"
          find build -type f \( -name "*.o" -o -name "*.a" -o -name "*.dylib" -o -perm +111 \) 2>/dev/null | wc -l | xargs echo "   Total build artifacts: "
          find build -type f -name "*.o" 2>/dev/null | head -5 | xargs -I{} echo "   - {}"

      - name: Direct Diagnostic - Force Find Output
        run: |
          echo "=== DIRECT DIAGNOSTIC OUTPUT ==="
          echo ""
          
          # Создаем простой CMake скрипт для диагностики
          cat > diagnostic.cmake << 'EOF'
          message(STATUS "=== DIAGNOSTIC SCRIPT ===")
          
          # Получаем все цели
          get_cmake_property(all_targets BUILDSYSTEM_TARGETS)
          message(STATUS "Total targets found: ${all_targets}")
          
          if(NOT all_targets)
            message(FATAL_ERROR "NO TARGETS FOUND! CMake configuration failed.")
          endif()
          
          foreach(target IN LISTS all_targets)
            message(STATUS "--- Target: ${target} ---")
            get_target_property(target_type ${target} TYPE)
            message(STATUS "    Type: ${target_type}")
            
            get_target_property(target_source_dir ${target} SOURCE_DIR)
            if(target_source_dir)
              message(STATUS "    Source dir: ${target_source_dir}")
            endif()
            
            get_target_property(target_sources ${target} SOURCES)
            if(target_sources)
              list(LENGTH target_sources num_sources)
              message(STATUS "    Sources: ${num_sources} files")
            endif()
            
            get_target_property(target_output ${target} OUTPUT_NAME)
            if(target_output)
              message(STATUS "    Output: ${target_output}")
            endif()
          endforeach()
          
          # Проверяем переменные
          if(DEFINED PLUGIN_FORMATS)
            message(STATUS "PLUGIN_FORMATS: ${PLUGIN_FORMATS}")
          else()
            message(STATUS "PLUGIN_FORMATS: NOT DEFINED!")
          endif()
          
          if(DEFINED JUCE_FETCHED)
            message(STATUS "JUCE fetched: ${JUCE_FETCHED}")
          endif()
          EOF
          
          echo "Running diagnostic script..."
          cmake -P diagnostic.cmake 2>&1

      - name: Last Resort - Manual Search
        run: |
          echo "=== MANUAL SEARCH IN BUILD DIRECTORY ==="
          echo ""
          
          echo "Full tree structure (depth 4):"
          find build -maxdepth 4 -type d 2>/dev/null | sort | head -50
          
          echo ""
          echo "Looking for ANY output files:"
          find build -type f -newer cmake_configure_full.log 2>/dev/null | head -20 || echo "   No new files created"
          
          echo ""
          echo "Checking for JUCE artefacts pattern:"
          find build -type d -name "*arte*" 2>/dev/null || echo "   No artefact directories"
          
          echo ""
          echo "All files with 'drumlabooh' in name:"
          find build -type f -name "*drumlabooh*" 2>/dev/null || echo "   None"

      - name: Create Detailed Report
        if: always()
        run: |
          echo "=== DETAILED REPORT ===" > report.txt
          echo "Build date: $(date)" >> report.txt
          echo "" >> report.txt
          
          echo "=== CMakeLists-alloses.txt SUMMARY ===" >> report.txt
          grep -c "project\|juce\|FORMATS\|create_drumlabooh" CMakeLists-alloses.txt 2>/dev/null | xargs echo "Key elements count: " >> report.txt
          
          echo "" >> report.txt
          echo "=== BUILD STATUS ===" >> report.txt
          if find build -name "*.o" -type f 2>/dev/null | grep -q "."; then
            echo "✓ Object files were created" >> report.txt
          else
            echo "✗ NO object files created" >> report.txt
          fi
          
          echo "" >> report.txt
          echo "=== NEXT STEPS ===" >> report.txt
          echo "1. Check CMakeLists-alloses.txt has:" >> report.txt
          echo "   - project() definition" >> report.txt
          echo "   - juce_add_plugin() call" >> report.txt
          echo "   - FORMATS AU for macOS" >> report.txt
          echo "2. Verify JUCE is fetched with FetchContent" >> report.txt
          echo "3. Check for CMake errors in logs" >> report.txt
          
          cat report.txt

      - name: Upload Critical Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: critical-debug-info
          path: |
            report.txt
            cmake_configure_full.log
            cmake_build_full.log
            cmake_trace_filtered.log
            targets.log
          retention-days: 30

      - name: Immediate Feedback
        if: always()
        run: |
          echo "=== IMMEDIATE FEEDBACK ==="
          echo ""
          
          # Проверяем ключевые вещи прямо здесь
          echo "1. Was CMakeLists-alloses.txt valid?"
          if grep -q "project(" CMakeLists-alloses.txt 2>/dev/null; then
            echo "   ✓ Contains project()"
          else
            echo "   ✗ MISSING project() definition"
          fi
          
          if grep -q "juce_add_plugin\|juce_add_app" CMakeLists-alloses.txt 2>/dev/null; then
            echo "   ✓ Contains JUCE plugin/app target"
          else
            echo "   ✗ MISSING juce_add_plugin/juce_add_app"
          fi
          
          if grep -q "FORMATS" CMakeLists-alloses.txt 2>/dev/null; then
            echo "   ✓ Contains FORMATS setting"
            grep -i "FORMATS" CMakeLists-alloses.txt | head -2
          else
            echo "   ✗ MISSING FORMATS setting"
          fi
          
          echo ""
          echo "2. Did CMake configure successfully?"
          if [ -f "build/CMakeCache.txt" ]; then
            echo "   ✓ CMakeCache.txt created"
          else
            echo "   ✗ NO CMakeCache.txt - configuration failed"
          fi
          
          echo ""
          echo "3. Were any targets built?"
          if find build -name "*.o" -type f 2>/dev/null | grep -q "."; then
            echo "   ✓ Object files found - compilation occurred"
          else
            echo "   ✗ NO compilation occurred"
          fi