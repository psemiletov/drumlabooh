# macOS AU build for Drumlabooh (universal binary)
# Запуск вручную через кнопку "Run workflow"
name: Build macOS AU Plugins

on:
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build-macos-au:
    name: Build Universal AU (macOS)
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: System Information
        run: |
          echo "=== System Information ==="
          uname -a
          sw_vers
          echo "CPU cores: $(sysctl -n hw.ncpu)"
          xcodebuild -version

      - name: Install CMake
        run: |
          brew update
          brew install cmake

      - name: Prepare CMakeLists.txt
        run: |
          if [ -f "CMakeLists-alloses.txt" ]; then
            echo "✓ Using CMakeLists-alloses.txt"
            cp CMakeLists-alloses.txt CMakeLists.txt
          else
            echo "✓ Using default CMakeLists.txt"
          fi
          echo "First lines of CMakeLists.txt:"
          head -n 20 CMakeLists.txt

      - name: Configure CMake (Universal AU)
        run: |
          cmake -S . -B build-au \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.13 \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DINSTALLKITS=OFF \
            -DMULTI=ON

          echo "=== CMake Configuration (relevant vars) ==="
          cmake -B build-au -L | grep -E "(FORMATS|AU|APPLE|ARCHITECTURES|MULTI|PLUGIN)" || true

      - name: Build AU Plugins
        run: |
          cmake --build build-au \
            --config ${{ env.BUILD_TYPE }} \
            --parallel $(sysctl -n hw.ncpu)

          echo "=== Built AU Components ==="
          find build-au -type d -name "*.component" | sort || echo "No components found"

      - name: Verify AU Bundle Structure
        run: |
          echo "=== Verifying AU Bundle Structure ==="
          shopt -s nullglob
          components=(build-au/*_Artefacts/AU/*.component)

          if [ ${#components[@]} -eq 0 ]; then
            echo "✗ ERROR: No .component bundles found!"
            exit 1
          fi

          for component in "${components[@]}"; do
            name=$(basename "$component")
            echo "Component: $name"

            if [ -f "$component/Contents/Info.plist" ]; then
              echo "  ✓ Info.plist present"
              plutil -lint "$component/Contents/Info.plist" >/dev/null && echo "  ✓ Info.plist valid" || echo "  ⚠ Info.plist has warnings"
            else
              echo "  ✗ Info.plist missing!"
            fi

            binary="$component/Contents/MacOS/${name%.component}"
            if [ -f "$binary" ]; then
              echo "  ✓ Binary exists"
              echo "    Architectures: $(lipo -info "$binary" | grep -o 'x86_64\|arm64' | tr '\n' ' ')"
            else
              echo "  ✗ Binary missing!"
            fi
            echo ""
          done

      - name: Validate with auval (non-fatal)
        run: |
          echo "=== Running auval validation ==="
          shopt -s nullglob
          for component in build-au/*_Artefacts/AU/*.component; do
            plugin_name=$(basename "$component" .component)
            echo "Validating: $plugin_name"
            auval -v aumu Petr PetR "$plugin_name" || echo "⚠ auval exited with code $? (common in CI — test locally if needed)"
            echo ""
          done
        continue-on-error: true

      - name: Ad-hoc sign AU components
        run: |
          echo "=== Ad-hoc signing components ==="
          shopt -s nullglob
          for component in build-au/*_Artefacts/AU/*.component; do
            echo "Signing: $(basename "$component")"
            codesign --force --sign - --timestamp=none --options runtime "$component" \
              || echo "⚠ codesign warning (may be ignored in CI)"
          done

      - name: Create Final Package
        run: |
          echo "=== Creating release package ==="
          mkdir -p release-au-universal

          cp -R build-au/*_Artefacts/AU/*.component release-au-universal/

          # Создаём README с помощью printf — полностью безопасно для YAML
          printf "%s\n" "=========================================" > release-au-universal/README.txt
          printf "%s\n" "Drumlabooh — macOS Audio Unit Plugins" >> release-au-universal/README.txt
          printf "%s\n" "=========================================" >> release-au-universal/README.txt
          printf "\nBuild date: %s\n" "$(date)" >> release-au-universal/README.txt
          printf "Architecture: Universal (x86_64 + arm64)\n" >> release-au-universal/README.txt
          printf "Minimum macOS: 10.13\n\n" >> release-au-universal/README.txt
          printf "Included plugins:\n" >> release-au-universal/README.txt
          ls release-au-universal/*.component | xargs basename | sed 's/^/  • /' >> release-au-universal/README.txt || echo "  (none)" >> release-au-universal/README.txt
          printf "\nInstallation:\n" >> release-au-universal/README.txt
          printf "1. Copy the .component files to one of these folders:\n" >> release-au-universal/README.txt
          printf "   • /Library/Audio/Plug-Ins/Components/     (for all users)\n" >> release-au-universal/README.txt
          printf "   • ~/Library/Audio/Plug-Ins/Components/    (for current user only)\n\n" >> release-au-universal/README.txt
          printf "2. Restart your DAW or rescan plugins.\n\n" >> release-au-universal/README.txt
          printf "Note:\n" >> release-au-universal/README.txt
          printf "• Plugins are ad-hoc signed — safe for local use.\n" >> release-au-universal/README.txt
          printf "• Tested in Logic Pro, GarageBand, Reaper, etc.\n\n" >> release-au-universal/README.txt
          printf "Enjoy the drums!\n" >> release-au-universal/README.txt
          printf "%s\n" "=========================================" >> release-au-universal/README.txt

          echo "Contents of package:"
          ls -l release-au-universal/

          tar czf drumlabooh-macos-AU-universal.tar.gz -C release-au-universal .
          echo "✓ Package created: drumlabooh-macos-AU-universal.tar.gz"
          ls -lh drumlabooh-macos-AU-universal.tar.gz

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: drumlabooh-macos-AU-universal
          path: drumlabooh-macos-AU-universal.tar.gz
          retention-days: 30