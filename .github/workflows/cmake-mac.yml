name: Build macOS AU Plugins - DEBUG

on:
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build-debug:
    name: Debug CMake Configuration
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install CMake
        run: |
          brew install cmake
          cmake --version

      - name: Show Repository Structure
        run: |
          echo "=== REPOSITORY STRUCTURE ==="
          find . -type f -name "*.txt" -o -name "*.cmake" | head -20
          echo ""
          ls -la
          echo ""
          echo "=== Source files exist? ==="
          ls -la Source/ 2>/dev/null || echo "Source directory not found"

      - name: Prepare CMakeLists.txt
        run: |
          echo "=== PREPARING CMAKELISTS.TXT ==="
          
          # Используем CMakeLists-alloses.txt
          if [ -f "CMakeLists-alloses.txt" ]; then
            cp CMakeLists-alloses.txt CMakeLists.txt
            echo "✓ Copied CMakeLists-alloses.txt to CMakeLists.txt"
          else
            echo "✗ CMakeLists-alloses.txt not found!"
            exit 1
          fi
          
          # Показываем первые 30 строк
          echo "=== First 30 lines of CMakeLists.txt ==="
          head -30 CMakeLists.txt

      - name: Run CMake with RAW Output
        run: |
          echo "=== RUNNING CMAKE (RAW UNFILTERED OUTPUT) ==="
          echo "This will show ALL output from CMake..."
          echo ""
          
          # Создаем временный build каталог
          mkdir -p _build
          cd _build
          
          # Запускаем CMake с сырым выводом
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15 \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DMULTI=ON 2>&1 | tee raw_cmake_output.txt
          
          CMake_EXIT_CODE=$?
          echo ""
          echo "=== CMake exit code: $CMake_EXIT_CODE ==="
          
          if [ $CMake_EXIT_CODE -ne 0 ]; then
            echo "❌ CMake failed!"
            echo "=== LAST 50 LINES OF OUTPUT ==="
            tail -50 raw_cmake_output.txt
          else
            echo "✓ CMake succeeded"
          fi

      - name: Check What CMake Created
        run: |
          echo "=== CHECKING BUILD DIRECTORY ==="
          
          if [ -d "_build" ]; then
            echo "1. Files in _build:"
            ls -la _build/
            
            echo ""
            echo "2. CMakeCache.txt exists:"
            ls -la _build/CMakeCache.txt 2>/dev/null || echo "  ❌ CMakeCache.txt not created!"
            
            echo ""
            echo "3. Looking for any generated files:"
            find _build -type f -name "*.cmake" -o -name "*.txt" | head -10 || echo "  No generated files"
            
            echo ""
            echo "4. Checking for JUCE:"
            find _build -type d -name "*juce*" 2>/dev/null || echo "  No JUCE directories"
          else
            echo "❌ _build directory not created!"
          fi

      - name: Simple CMake Test
        run: |
          echo "=== SIMPLE CMAKE TEST ==="
          
          # Создаем минимальный тестовый CMakeLists.txt
          cat > test_cmake.cmake << 'EOF'
          message(STATUS "=== MINIMAL CMAKE TEST ===")
          
          # Простейший проект
          cmake_minimum_required(VERSION 3.15)
          project(TestProject)
          
          message(STATUS "CMake version: ${CMAKE_VERSION}")
          message(STATUS "Source dir: ${CMAKE_SOURCE_DIR}")
          message(STATUS "Binary dir: ${CMAKE_BINARY_DIR}")
          
          # Проверяем можем ли мы найти файлы
          if(EXISTS "${CMAKE_SOURCE_DIR}/CMakeLists.txt")
            message(STATUS "✓ CMakeLists.txt exists")
          else()
            message(STATUS "✗ CMakeLists.txt NOT found")
          endif()
          
          if(EXISTS "${CMAKE_SOURCE_DIR}/Source/PluginProcessor.cpp")
            message(STATUS "✓ Source files exist")
          else()
            message(STATUS "✗ Source files NOT found")
          endif()
          EOF
          
          echo "Running test script..."
          cmake -P test_cmake.cmake

      - name: Check FetchContent Issue
        run: |
          echo "=== CHECKING FETCHCONTENT ISSUE ==="
          
          # Пробуем скачать JUCE вручную
          echo "1. Testing JUCE download URL:"
          JUCE_URL="https://github.com/juce-framework/JUCE/archive/refs/tags/8.0.11.tar.gz"
          echo "URL: $JUCE_URL"
          
          echo ""
          echo "2. Checking network connectivity:"
          curl -I --connect-timeout 10 "$JUCE_URL" 2>&1 | head -5 || echo "  Network test failed"
          
          echo ""
          echo "3. Checking if CMake can fetch content:"
          cat > test_fetch.cmake << 'EOF'
          cmake_minimum_required(VERSION 3.15)
          
          include(FetchContent)
          
          message(STATUS "Testing FetchContent...")
          
          FetchContent_Declare(
            TestFetch
            URL https://github.com/juce-framework/JUCE/archive/refs/tags/8.0.11.tar.gz
          )
          
          message(STATUS "FetchContent declared")
          
          FetchContent_GetProperties(TestFetch)
          if(NOT TestFetch_POPULATED)
            message(STATUS "Would fetch TestFetch...")
          else()
            message(STATUS "TestFetch already populated")
          endif()
          EOF
          
          mkdir -p test_fetch_build
          cd test_fetch_build
          cmake -P ../test_fetch.cmake 2>&1

      - name: Create Diagnostic Report
        if: always()
        run: |
          echo "=== DIAGNOSTIC REPORT ==="
          echo ""
          
          # Проверяем ключевые файлы
          echo "1. ESSENTIAL FILES CHECK:"
          
          if [ -f "CMakeLists.txt" ]; then
            echo "   ✓ CMakeLists.txt exists"
            FILE_SIZE=$(wc -l < CMakeLists.txt)
            echo "   Lines: $FILE_SIZE"
          else
            echo "   ✗ CMakeLists.txt MISSING"
          fi
          
          if [ -d "Source" ]; then
            echo "   ✓ Source directory exists"
            SOURCE_FILES=$(find Source -name "*.cpp" -o -name "*.c" 2>/dev/null | wc -l)
            echo "   Source files: $SOURCE_FILES"
          else
            echo "   ✗ Source directory MISSING"
          fi
          
          echo ""
          echo "2. CMAKE CONFIGURATION RESULT:"
          if [ -f "_build/CMakeCache.txt" ]; then
            echo "   ✓ CMakeCache.txt created"
            echo "   Project name from cache:"
            grep "CMAKE_PROJECT_NAME" _build/CMakeCache.txt 2>/dev/null || echo "    Not found"
          else
            echo "   ✗ CMake configuration FAILED"
            echo "   (No CMakeCache.txt created)"
          fi
          
          echo ""
          echo "3. MOST LIKELY ISSUES:"
          echo "   a) Source files missing from repository"
          echo "   b) Network issue fetching JUCE"
          echo "   c) CMake version incompatible"
          echo "   d) Syntax error in CMakeLists.txt"
          
          echo ""
          echo "4. NEXT STEPS:"
          echo "   Check the raw CMake output above for error messages"

      - name: Upload Raw Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: raw-cmake-debug
          path: |
            _build/raw_cmake_output.txt
            test_cmake.cmake
            test_fetch.cmake
          retention-days: 30