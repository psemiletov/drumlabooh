name: Build macOS AU Plugins

on:
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build-macos-au:
    name: Build Universal AU (macOS)
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        run: |
          brew update
          brew install cmake
          brew install pkg-config
          
          echo "=== Versions ==="
          cmake --version

      - name: Setup CMakeLists-alloses.txt
        run: |
          echo "=== SETUP: Using CMakeLists-alloses.txt ==="
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          if [ ! -f "CMakeLists-alloses.txt" ]; then
            echo "‚ùå ERROR: CMakeLists-alloses.txt not found!"
            ls -la CMakeLists*.txt
            exit 1
          fi
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π CMakeLists.txt –µ—Å–ª–∏ –µ—Å—Ç—å
          if [ -f "CMakeLists.txt" ]; then
            cp CMakeLists.txt CMakeLists.txt.original
            echo "‚úì Original CMakeLists.txt backed up"
          fi
          
          # –ö–æ–ø–∏—Ä—É–µ–º CMakeLists-alloses.txt –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π
          cp CMakeLists-alloses.txt CMakeLists.txt
          
          echo "‚úì CMakeLists-alloses.txt copied to CMakeLists.txt"
          echo ""
          echo "=== First 20 lines of new CMakeLists.txt ==="
          head -20 CMakeLists.txt
          
          echo ""
          echo "=== Checking for AU configuration ==="
          grep -i "apple\|macos\|au\|format" CMakeLists.txt | head -10 || echo "  No AU config found"

      - name: Configure CMake
        run: |
          echo "=== CONFIGURE CMAKE ==="
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15 \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DMULTI=ON \
            -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON \
            2>&1 | tee cmake_configure.log
          
          echo "=== Checking CMakeCache ==="
          grep -i "juce\|plugin\|au\|format\|apple" build/CMakeCache.txt 2>/dev/null | head -20 || true

      - name: Build Plugins
        run: |
          echo "=== BUILD PLUGINS ==="
          
          cmake --build build \
            --config ${{ env.BUILD_TYPE }} \
            --parallel $(sysctl -n hw.ncpu) \
            --verbose 2>&1 | tee cmake_build.log
          
          echo "=== Build completed ==="

      - name: Find AU Components (Optimized Search)
        run: |
          echo "=== FINDING AU COMPONENTS ==="
          
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞
          cat > find_components.sh << 'EOF'
          #!/bin/bash
          
          echo "Search strategy:"
          echo "1. Standard JUCE 8 paths"
          echo "2. Any .component directories"
          echo "3. Bundle-like structures"
          
          # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—É—Ç–∏ JUCE 8
          STANDARD_PATHS=(
            "build/${PROJECT_NAME}_artefacts"
            "build/${BUILD_TYPE}/${PROJECT_NAME}_artefacts"
            "build/JUCE/temp/${BUILD_TYPE}"
            "build/_deps/juce-build/temp/${BUILD_TYPE}"
          )
          
          # –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–º—è –ø—Ä–æ–µ–∫—Ç–∞
          PROJECT_NAME=$(grep -m1 "project(" CMakeLists.txt | sed 's/.*(\([^ ]*\).*/\1/' 2>/dev/null || echo "DRUMLABOOH")
          echo "Project name from CMakeLists: $PROJECT_NAME"
          
          echo ""
          echo "=== Checking standard paths ==="
          for path in "${STANDARD_PATHS[@]}"; do
            if [ -d "$path" ]; then
              echo "‚úì Path exists: $path"
              find "$path" -type d -name "*.component" 2>/dev/null | while read comp; do
                echo "  Found: $comp"
              done
            fi
          done
          
          echo ""
          echo "=== Deep search in build directory ==="
          COMPONENTS=$(find build -type d -name "*.component" 2>/dev/null)
          if [ -n "$COMPONENTS" ]; then
            echo "‚úì Found .component directories:"
            echo "$COMPONENTS"
          else
            echo "‚úó No .component directories found"
          fi
          
          echo ""
          echo "=== Looking for any plugin output ==="
          find build -type f \( -name "*.dylib" -o -name "*.vst3" -o -name "*.component" \) 2>/dev/null | head -10 || echo "  None found"
          
          echo ""
          echo "=== Checking what WAS built ==="
          echo "Object files count: $(find build -name "*.o" -type f 2>/dev/null | wc -l)"
          echo "Executable files: $(find build -type f -perm +111 2>/dev/null | wc -l)"
          EOF
          
          chmod +x find_components.sh
          ./find_components.sh 2>&1 | tee find_output.log
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
          find build -type d -name "*.component" 2>/dev/null > components_found.txt || true
          
          if [ -s components_found.txt ]; then
            echo "‚úÖ SUCCESS: Found AU components!"
            echo "Components:"
            cat components_found.txt
          else
            echo "‚ùå No components found"
          fi

      - name: Diagnostic - Check JUCE Configuration
        run: |
          echo "=== DIAGNOSTIC: JUCE Configuration ==="
          
          echo "1. Checking CMakeLists.txt for JUCE settings:"
          grep -n -B2 -A2 "juce_add_plugin\|FORMATS\|JUCE\|FetchContent" CMakeLists.txt | head -30 || echo "  Not found"
          
          echo ""
          echo "2. Checking if JUCE was downloaded:"
          if [ -d "build/_deps" ]; then
            echo "‚úì _deps directory exists"
            find build/_deps -type d -name "*juce*" 2>/dev/null || echo "  No juce directory"
          else
            echo "‚úó _deps directory NOT found - JUCE not fetched!"
          fi
          
          echo ""
          echo "3. Checking CMake targets:"
          if [ -d "build" ]; then
            cmake --build build --target help 2>&1 | grep -i "drumlabooh\|plugin\|au\|juce" || echo "  No relevant targets"
          fi

      - name: Create Package
        run: |
          echo "=== CREATING PACKAGE ==="
          mkdir -p package
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
          if [ -f components_found.txt ] && [ -s components_found.txt ]; then
            echo "Packaging found components..."
            
            mkdir -p package/plugins
            while IFS= read -r component; do
              if [ -d "$component" ]; then
                name=$(basename "$component")
                echo "  Adding: $name"
                cp -R "$component" "package/plugins/"
              fi
            done < components_found.txt
            
            COUNT=$(ls -1 package/plugins/*.component 2>/dev/null | wc -l | tr -d ' ')
            echo "‚úÖ Packaged $COUNT plugin(s)"
          else
            echo "‚ö†Ô∏è No components to package"
            echo "Build completed but no .component files were produced" > package/README.txt
            echo "" >> package/README.txt
            echo "Possible issues:" >> package/README.txt
            echo "1. Wrong plugin format in CMakeLists-alloses.txt" >> package/README.txt
            echo "2. JUCE not configured for AU" >> package/README.txt
            echo "3. Build target not created" >> package/README.txt
          fi
          
          # –°–æ–∑–¥–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª
          cat > package/BUILD_INFO.md << 'EOF'
          # Drumlabooh Build Information
          
          ## Source
          - CMake file: CMakeLists-alloses.txt
          - Build date: $(date)
          
          ## Configuration
          - Build type: ${{ env.BUILD_TYPE }}
          - macOS target: 10.15+
          - Architectures: x86_64, arm64
          - Multi-channel: ON
          
          ## Contents
          EOF
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –µ—Å–ª–∏ –µ—Å—Ç—å
          if [ -d "package/plugins" ]; then
            echo "## Plugins included:" >> package/BUILD_INFO.md
            for plugin in package/plugins/*.component; do
              if [ -d "$plugin" ]; then
                basename "$plugin" | sed 's/\.component$//' | sed 's/^/- /' >> package/BUILD_INFO.md
              fi
            done
          else
            echo "## No plugins were built" >> package/BUILD_INFO.md
          fi
          
          # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤
          cd package
          tar czf ../drumlabooh-macos-alloses-au.tar.gz .
          cd ..
          
          echo "üì¶ Package created: drumlabooh-macos-alloses-au.tar.gz"
          ls -lh drumlabooh-macos-alloses-au.tar.gz

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: alloses-build-logs
          path: |
            cmake_configure.log
            cmake_build.log
            find_output.log
            components_found.txt
            CMakeLists.txt.original
          retention-days: 7

      - name: Upload Plugin Package
        uses: actions/upload-artifact@v4
        with:
          name: drumlabooh-alloses-au-plugins
          path: drumlabooh-macos-alloses-au.tar.gz
          retention-days: 30

      - name: Show Final Status
        if: always()
        run: |
          echo "=== FINAL STATUS ==="
          echo ""
          
          if [ -f components_found.txt ] && [ -s components_found.txt ]; then
            echo "‚úÖ SUCCESS: AU plugins built using CMakeLists-alloses.txt"
            echo ""
            echo "Components found:"
            cat components_found.txt
          else
            echo "‚ùå FAILURE: No AU plugins built"
            echo ""
            echo "Debug information has been saved to artifacts."
            echo "Download 'alloses-build-logs' to see:"
            echo "1. cmake_configure.log - CMake configuration"
            echo "2. cmake_build.log - Build process"
            echo "3. find_output.log - Search results"
            echo ""
            echo "Common issues with CMakeLists-alloses.txt:"
            echo "1. Missing 'FORMATS AU' for macOS"
            echo "2. JUCE not properly included"
            echo "3. Plugin targets not defined"
          fi